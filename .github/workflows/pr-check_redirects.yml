name: Check Redirects

on:
  pull_request:
    branches:
      - main
    paths:
      - files/**/_redirects.txt
      - .github/workflows/pr-check_redirects.yml

jobs:
  check_redirects:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          path: mdn/translated-content

      - uses: actions/checkout@v2
        with:
          repository: mdn/content
          path: mdn/content
          # Yes, this means fetch EVERY COMMIT EVER.
          # It's probably not sustainable in the far future (e.g. past 2021)
          # but for now it's good enough. We'll need all the history
          # so we can figure out each document's last-modified date.
          fetch-depth: 0

      - name: Setup Node.js environment
        uses: actions/setup-node@v2.1.4
        with:
          node-version: "12"

      - name: Get yarn cache directory path
        id: yarn-cache-dir-path
        run: echo "::set-output name=dir::$(yarn cache dir)"
      - uses: actions/cache@v2.1.4
        id: yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
        with:
          path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install all yarn packages
        run: |
          cd $GITHUB_WORKSPACE/mdn/content/
          yarn --frozen-lockfile

      - name: Check redirects file(s)
        run: |
          export CONTENT_ROOT=$GITHUB_WORKSPACE/mdn/content/files
          export TRANSLATED_CONTENT_ROOT=$GITHUB_WORKSPACE/mdn/translated-content/files

          cd $GITHUB_WORKSPACE/mdn/content/
          yarn content validate-redirects --strict
